
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="zkWasm%20Protocol.html">
      
      
        <link rel="next" href="Withdraw.html">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.45">
    
    
      
        <title>Deposit - zkWasm Development Recipe</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.0253249f.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="pink">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#deposit-workflow" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../index.html" title="zkWasm Development Recipe" class="md-header__button md-logo" aria-label="zkWasm Development Recipe" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            zkWasm Development Recipe
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Deposit
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="pink"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="blue" data-md-color-accent="lime"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../index.html" title="zkWasm Development Recipe" class="md-nav__button md-logo" aria-label="zkWasm Development Recipe" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    zkWasm Development Recipe
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../index.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Getting Started
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Getting Started
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Setup%20Environment.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Setup Environment
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Quick%20Tutorial.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Quick Tutorial
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Core Documentation
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Core Documentation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Core%20Concepts.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Core Concepts
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../zkWasm%20Overview.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    zkWasm Overview
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Design Guide
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Design Guide
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Design%20Application%20as%20State%20Machine.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Design Application as State Machine
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Development Guide
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Development Guide
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../zkWasm%20Rust%20SDK.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    zkWasm Rust SDK
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Web3%20Development%20Frameworks.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Web3 Development Frameworks
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="">
            
  
  <span class="md-ellipsis">
    zkWasm Mini Rollup
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            zkWasm Mini Rollup
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../zkwasm-mini-rollup/Rollup%20Overview.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../zkwasm-mini-rollup/Rollup%20Host.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Host Environment
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../zkwasm-mini-rollup/Rollup%20Database.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Database Service
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../zkwasm-mini-rollup/Rollup%20Server.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Server Implementation (zkWasm-ts-Server)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../zkwasm-mini-rollup/Rollup%20Convention.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Convension
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" checked>
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="">
            
  
  <span class="md-ellipsis">
    zkWasm Protocol
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            zkWasm Protocol
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="zkWasm%20Protocol.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    zkWasm Protocol Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Deposit
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="Deposit.html" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Deposit
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    <span class="md-ellipsis">
      Introduction
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-topup-function" class="md-nav__link">
    <span class="md-ellipsis">
      The Topup Function
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deposit-monitor" class="md-nav__link">
    <span class="md-ellipsis">
      Deposit Monitor
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deposit-action" class="md-nav__link">
    <span class="md-ellipsis">
      Deposit Action
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Withdraw.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Withdraw
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    <span class="md-ellipsis">
      Introduction
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-topup-function" class="md-nav__link">
    <span class="md-ellipsis">
      The Topup Function
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deposit-monitor" class="md-nav__link">
    <span class="md-ellipsis">
      Deposit Monitor
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deposit-action" class="md-nav__link">
    <span class="md-ellipsis">
      Deposit Action
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="deposit-workflow">Deposit Workflow</h1>
<h2 id="introduction">Introduction</h2>
<p>In this section, we will use what we have learned from <a href="zkWasm%20Protocol.html">zkWasm Protocol Overview</a> to implement a deposit workflow. </p>
<h2 id="the-topup-function">The Topup Function</h2>
<p>In the proxy contract, we have a function <code>topup</code> which can be called by any user to deposit specific token into the zkWasm Rollup Application. </p>
<div class="highlight"><pre><span></span><code><span class="kt">function</span><span class="w"> </span><span class="nv">topup</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="kt">uint128</span><span class="w"> </span><span class="nv">tidx</span><span class="p">,</span>
<span class="w">    </span><span class="kt">uint64</span><span class="w"> </span><span class="nv">pid_1</span><span class="p">,</span>
<span class="w">    </span><span class="kt">uint64</span><span class="w"> </span><span class="nv">pid_2</span><span class="p">,</span>
<span class="w">    </span><span class="kt">uint128</span><span class="w"> </span><span class="nv">amount</span><span class="w">  </span><span class="c1">//in wei</span>
<span class="p">)</span><span class="w"> </span>nonReentrant<span class="w"> </span><span class="kt">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tokenid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>get_token_uid<span class="p">(</span>tidx<span class="p">);</span>
<span class="w">    </span><span class="kt">require</span><span class="w"> </span><span class="p">(</span>_is_local<span class="p">(</span>tokenid<span class="p">),</span><span class="w"> </span><span class="s2">&quot;token is not a local erc token&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="kt">address</span><span class="w"> </span><span class="nv">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">address</span><span class="p">(</span><span class="kt">uint160</span><span class="p">(</span>tokenid<span class="p">));</span>
<span class="w">    </span>IERC20<span class="w"> </span>underlying_token<span class="w"> </span><span class="o">=</span><span class="w"> </span>IERC20<span class="p">(</span>token<span class="p">);</span>

<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>underlying_token<span class="p">.</span>balanceOf<span class="p">(</span><span class="k">msg.sender</span><span class="p">);</span>
<span class="w">    </span><span class="kt">require</span><span class="p">(</span>balance<span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span>amount<span class="p">,</span><span class="w"> </span><span class="s2">&quot;Insufficient Balance&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">allowance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>underlying_token<span class="p">.</span>allowance<span class="p">(</span><span class="k">msg.sender</span><span class="p">,</span><span class="w"> </span><span class="kt">address</span><span class="p">(</span><span class="kt">this</span><span class="p">));</span>
<span class="w">    </span><span class="kt">require</span><span class="p">(</span>allowance<span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span>amount<span class="p">,</span><span class="w"> </span><span class="s2">&quot;Insufficient Allowance&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="c1">//USDT does not follow ERC20 interface so have to use the following safer method</span>
<span class="w">    </span>TransferHelper<span class="p">.</span>safeTransferFrom<span class="p">(</span><span class="kt">address</span><span class="p">(</span>underlying_token<span class="p">),</span><span class="w"> </span><span class="k">msg.sender</span><span class="p">,</span><span class="w"> </span><span class="kt">address</span><span class="p">(</span><span class="kt">this</span><span class="p">),</span><span class="w"> </span>amount<span class="p">);</span>

<span class="w">    </span><span class="c1">//Tbd: Charge fees to developer</span>
<span class="w">    </span>emit<span class="w"> </span>TopUp<span class="p">(</span>_l1_address<span class="p">(</span>token<span class="p">),</span><span class="w"> </span><span class="k">msg.sender</span><span class="p">,</span><span class="w"> </span>pid_1<span class="p">,</span><span class="w"> </span>pid_2<span class="p">,</span><span class="w"> </span>amount<span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>The <code>topup</code> function accepts four parameters that control the deposit process:</p>
<ul>
<li>The <code>tidx</code> parameter (uint128) represents the token index in the contract's token registry. This index is used to retrieve the actual token contract address through the <code>get_token_uid</code> function.</li>
<li>The <code>pid_1</code> and <code>pid_2</code> parameters (both uint64) together form a unique player identifier within the zkWasm system. This two-part identifier corresponds to the <code>player_id: [u64; 2]</code> structure used in the <code>Player</code> struct in the zkWasm mini rollup ABI. Therefore, we can use the <code>pid_1</code> and <code>pid_2</code> to identify the which player is depositing the token.</li>
<li>The <code>amount</code> parameter (uint128) specifies the deposit amount in wei, representing the smallest unit of the token being deposited, this means the amount has to multiple by 10^18 to represent the actual amount of the token.</li>
</ul>
<p>When a user calls the <code>topup</code> function, the following steps will be performed:</p>
<ol>
<li>The <code>topup</code> function will first check if the token is a local token (which means the token is supported by the blockchain) by calling the <code>_is_local</code> function. If the token is not a local token, the function will revert with an error message.</li>
<li>The function will then check if the user has enough balance and allowance to deposit the token. If not, the function will revert with an error message.</li>
<li>The function will then transfer the token from the user's account to the proxy contract.</li>
<li>The function will then emit a <code>TopUp</code> event to notify the zkWasm Rollup Application that the user has deposited the token.</li>
</ol>
<p>You can add more features to the <code>topup</code> function, such as charging fees to the developer, or checking if the user is on the whitelist.</p>
<p>Image a user has deposited a token into the zkWasm Rollup Application and the <code>TopUp</code> event has been emitted. What will happen next? </p>
<p>Actually... nothing will happen next. The <code>TopUp</code> event is just a notification event, it does not trigger any further actions. So how does the zkWasm Rollup Application know that the user has deposited the token? We need to implement a mechanism to listen to the <code>TopUp</code> event and trigger the corresponding actions to process the deposit in the zkWasm Rollup Application. A good way to do this is to use a deposit monitor which operates by the server's admin.</p>
<h2 id="deposit-monitor">Deposit Monitor</h2>
<p>In this section, we will implement a typescript node.js service that can listen to the <code>TopUp</code> event and trigger the corresponding actions to process the deposit in the zkWasm Rollup Application. The original code is in the <code>deposit.ts</code> <a href="https://github.com/riddles-are-us/zkwasm-automata/blob/main/ts/src/deposit.ts">file</a> in a game called <a href="https://automata.zkplay.app/">automata</a>.</p>
<p>Let's start by implementing the service that can:
1. retrieve all past <code>TopUp</code> events from the proxy contract and process each event. 
2. listen to new <code>TopUp</code> events from the proxy contract and process each event.</p>
<p>The service can be concluded as the following code:
<div class="highlight"><pre><span></span><code><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">dbName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SETTLEMENT_CONTRACT_ADDRESS</span><span class="si">}</span><span class="sb">_deposit`</span><span class="p">;</span><span class="w"> </span><span class="c1">// Dynamically set DB name using contract address</span>
<span class="w">    </span><span class="c1">// Connect to MongoDB (without deprecated options)</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">mongoose</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">MONGO_URI</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">dbName</span><span class="p">,</span>
<span class="w">    </span><span class="p">}).</span><span class="nx">then</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;MongoDB connected&#39;</span><span class="p">));</span>
<span class="w">    </span><span class="c1">// Get all TopUp events from the contract</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">getTopUpEvents</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// Listen for new TopUp events</span>
<span class="w">    </span><span class="nx">proxyContract</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;TopUp&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">l1token</span><span class="p">,</span><span class="w"> </span><span class="nx">address</span><span class="p">,</span><span class="w"> </span><span class="nx">pid_1</span><span class="p">,</span><span class="w"> </span><span class="nx">pid_2</span><span class="p">,</span><span class="w"> </span><span class="nx">amount</span><span class="p">,</span><span class="w"> </span><span class="nx">event</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span>
<span class="w">        </span><span class="c1">//const eventLog = event as EventLog;  // Explicitly cast to EventLog</span>
<span class="w">        </span><span class="c1">//console.log(eventLog);</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`New TopUp event detected: </span><span class="si">${</span><span class="nx">event</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">transactionHash</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// Process the new TopUp event</span>
<span class="w">        </span><span class="k">await</span><span class="w"> </span><span class="nx">processTopUpEvent</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">log</span><span class="p">);</span>
<span class="w">    </span><span class="p">});</span>
<span class="p">}</span>
</code></pre></div></p>
<p>In order to make sure the events will not be processed multiple times, we need to store the events transaction information in the database. Here we use MongoDB to do this.</p>
<p><div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">txSchema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">mongoose</span><span class="p">.</span><span class="nx">Schema</span><span class="p">({</span>
<span class="w">    </span><span class="nx">txHash</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="nx">required</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span><span class="w"> </span><span class="nx">unique</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="c1">// Ensure txHash is unique</span>
<span class="w">    </span><span class="nx">state</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="kd">enum</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;pending&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;in-progress&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="p">],</span><span class="w"> </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;pending&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">,</span><span class="w"> </span><span class="nx">default</span><span class="o">:</span><span class="w"> </span><span class="kt">Date.now</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">l1token</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="nx">required</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">address</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="nx">required</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">pid_1</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="nb">BigInt</span><span class="p">,</span><span class="w"> </span><span class="nx">required</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">pid_2</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="nb">BigInt</span><span class="p">,</span><span class="w"> </span><span class="nx">required</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">amount</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="nb">BigInt</span><span class="p">,</span><span class="w"> </span><span class="nx">required</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="w"> </span><span class="p">},</span>
<span class="p">});</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">TxHash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">&#39;TxHash&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">txSchema</span><span class="p">);</span>
</code></pre></div>
The above code defines a schema for the <code>TxHash</code> collection in the database. Each <code>TxHash</code> document will have fields that correspond to the parameters of the <code>TopUp</code> event. Notably, the state field is used to indicate the status of the event processing which could be used to prevent the event from being processed multiple times.</p>
<p>When we start the service, after connecting to the database, we will first retrieve all past <code>TopUp</code> events from the proxy contract and process each event. This is specifically useful for the server's admin to check if there are any deposits that need to be processed when initializing the monitor:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Function to retrieve all past TopUp events</span>
<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getTopUpEvents</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// You can specify a block range, or use `fromBlock: 0` to query all events</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">filter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">proxyContract</span><span class="p">.</span><span class="nx">filters</span><span class="p">.</span><span class="nx">TopUp</span><span class="p">();</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">events</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">proxyContract</span><span class="p">.</span><span class="nx">queryFilter</span><span class="p">(</span><span class="nx">filter</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;latest&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Found </span><span class="si">${</span><span class="nx">events</span><span class="p">.</span><span class="nx">length</span><span class="si">}</span><span class="sb"> TopUp events.`</span><span class="p">);</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">event</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">events</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">eventLog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">event</span><span class="p">;</span>
<span class="w">            </span><span class="c1">// Process each past event</span>
<span class="w">            </span><span class="k">await</span><span class="w"> </span><span class="nx">processTopUpEvent</span><span class="p">(</span><span class="nx">eventLog</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Error retrieving TopUp events:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Then the service will listen to new <code>TopUp</code> events from the proxy contract and process each event:
<div class="highlight"><pre><span></span><code><span class="nx">proxyContract</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;TopUp&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">l1token</span><span class="p">,</span><span class="w"> </span><span class="nx">address</span><span class="p">,</span><span class="w"> </span><span class="nx">pid_1</span><span class="p">,</span><span class="w"> </span><span class="nx">pid_2</span><span class="p">,</span><span class="w"> </span><span class="nx">amount</span><span class="p">,</span><span class="w"> </span><span class="nx">event</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//const eventLog = event as EventLog;  // Explicitly cast to EventLog</span>
<span class="w">    </span><span class="c1">//console.log(eventLog);</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`New TopUp event detected: </span><span class="si">${</span><span class="nx">event</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">transactionHash</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// Process the new TopUp event</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">processTopUpEvent</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">log</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></p>
<p>Once there is a new <code>TopUp</code> event, the service will process the event by calling the <code>processTopUpEvent</code> function. </p>
<p>Let's delve into the <code>processTopUpEvent</code> function: </p>
<div class="highlight"><pre><span></span><code><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">processTopUpEvent</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">eventLog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">event</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">l1token</span><span class="p">,</span><span class="w"> </span><span class="nx">address</span><span class="p">,</span><span class="w"> </span><span class="nx">pid_1</span><span class="p">,</span><span class="w"> </span><span class="nx">pid_2</span><span class="p">,</span><span class="w"> </span><span class="nx">amount</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">eventLog</span><span class="p">.</span><span class="nx">args</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">l1token</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="p">(</span><span class="k">await</span><span class="w"> </span><span class="nx">proxyContract</span><span class="p">.</span><span class="nx">_tokens</span><span class="p">(</span><span class="mf">0</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Skip not the right token: &#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">l1token</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`TopUp event received: pid_1=</span><span class="si">${</span><span class="nx">pid_1</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span><span class="si">}</span><span class="sb">, pid_2=</span><span class="si">${</span><span class="nx">pid_2</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span><span class="si">}</span><span class="sb">, amount=</span><span class="si">${</span><span class="nx">amount</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span><span class="si">}</span><span class="sb"> wei`</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// Check if this transaction is already in the database and in &#39;pending&#39; or &#39;in-progress&#39; state</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">tx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">findTxByHash</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">transactionHash</span><span class="p">);</span>
<span class="w">    </span><span class="p">...</span>
<span class="p">}</span>
</code></pre></div>
<p>First, the function will check if the token is the right token (the token that can be deposited into the zkWasm Rollup Application) by comparing the <code>l1token</code> (which is the uid of the token) with the token uid stored in the proxy contract. If the token is not the right token, the function will skip the event. </p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>You can implement your own logic to check if the token is the right token by checking the token's uid, for example, if you wanna make all the tokens that has been registered in the proxy contract can be deposited into the zkWasm Rollup Application, you can skip the check (because the token has been checked in the <code>topup</code> function in the proxy contract when user deposit the token) or check if the token is supported by the proxy contract by calling the <code>allTokens</code> function and check if the <code>l1token</code> is in the <code>allTokens</code> array.</p>
</div>
<p>Then the function will check if the transaction is already in the database by calling the <code>findTxByHash</code> function:</p>
<div class="highlight"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="nx">tx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">findTxByHash</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">transactionHash</span><span class="p">);</span>
</code></pre></div>
<p>If the transaction is not in the database, the function will create a new transaction record which has the initial state as <code>pending</code> in the database:</p>
<div class="highlight"><pre><span></span><code><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">tx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Transaction hash not found: </span><span class="si">${</span><span class="nx">event</span><span class="p">.</span><span class="nx">transactionHash</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">            </span><span class="c1">// Save tx hash and initial state as pending, along with other details</span>
<span class="w">            </span><span class="nx">tx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">TxHash</span><span class="p">({</span>
<span class="w">                </span><span class="nx">txHash</span><span class="o">:</span><span class="w"> </span><span class="kt">event.transactionHash</span><span class="p">,</span>
<span class="w">                </span><span class="nx">state</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;pending&#39;</span><span class="p">,</span><span class="w"> </span><span class="c1">// Initially set to pending</span>
<span class="w">                </span><span class="nx">l1token</span><span class="p">,</span>
<span class="w">                </span><span class="nx">address</span><span class="p">,</span>
<span class="w">                </span><span class="nx">pid_1</span><span class="p">,</span>
<span class="w">                </span><span class="nx">pid_2</span><span class="p">,</span>
<span class="w">                </span><span class="nx">amount</span><span class="p">,</span>
<span class="w">            </span><span class="p">});</span>
<span class="w">            </span><span class="k">await</span><span class="w"> </span><span class="nx">tx</span><span class="p">.</span><span class="nx">save</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
</code></pre></div>
<p>If the transaction is already in the database or just created through the above code, the function will check if the transaction is in the <code>pending</code> status, if so, it will proceed to process the deposit in the zkWasm Rollup Application:</p>
<div class="highlight"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">tx</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">tx</span><span class="p">.</span><span class="nx">state</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;pending&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Set transaction state to &quot;in-progress&quot;</span>
<span class="w">        </span><span class="k">await</span><span class="w"> </span><span class="nx">updateTxState</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">transactionHash</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;in-progress&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// Convert amount from wei to ether</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="nx">amountInEther</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">amount</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nb">BigInt</span><span class="p">(</span><span class="mf">10</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="mf">18</span><span class="p">);</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Deposited amount (in ether): &quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">amountInEther</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">amountInEther</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">`--------------Skip: Amount must be at least 1 Titan (in ether instead of wei) </span><span class="si">${</span><span class="nx">event</span><span class="p">.</span><span class="nx">transactionHash</span><span class="si">}</span><span class="sb">\n`</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Proceed with the deposit</span>
<span class="w">            </span><span class="k">await</span><span class="w"> </span><span class="nx">admin</span><span class="p">.</span><span class="nx">deposit</span><span class="p">(</span><span class="nx">pid_1</span><span class="p">,</span><span class="w"> </span><span class="nx">pid_2</span><span class="p">,</span><span class="w"> </span><span class="nx">amountInEther</span><span class="p">);</span>
<span class="w">            </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`------------------Deposit successful! </span><span class="si">${</span><span class="nx">event</span><span class="p">.</span><span class="nx">transactionHash</span><span class="si">}</span><span class="sb">\n`</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="c1">// After successful deposit, set state to &#39;completed&#39;</span>
<span class="w">        </span><span class="k">await</span><span class="w"> </span><span class="nx">updateTxState</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">transactionHash</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Error during deposit:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// In case of failure, mark as &#39;failed&#39;</span>
<span class="w">        </span><span class="c1">// await updateTxState(event.transactionHash, &#39;failed&#39;);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>The above code will set the transaction state to <code>in-progress</code>, then convert the amount from wei to ether, and then call the <code>deposit</code> function in the zkWasm Rollup Application to process the deposit. After the deposit is successful, the function will set the transaction state to <code>completed</code>. Howerver, if the deposit is failed, the status of the transaction will not be updated as <code>completed</code> and maintain as <code>in-progress</code>.</p>
<div class="admonition info">
<p class="admonition-title">Admin Setup</p>
<p>The <code>deposit</code> function is a function in the zkWasm Rollup Application, which is only callable by the admin. You will need to setup the admin key as <code>SERVER_ADMIN_KEY</code> in the <code>.env</code> file first before you can call the <code>deposit</code> function. Also, as a kind of "player", you will need to install the admin into the zkWasm Rollup Application by calling the <code>installPlayer</code> function:
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">rpc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ZKWasmAppRpc</span><span class="p">(</span><span class="s2">&quot;https://rpc.zkplay.app&quot;</span><span class="p">);</span>
<span class="kd">let</span><span class="w"> </span><span class="nx">admin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Player</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SERVER_ADMIN_KEY</span><span class="p">,</span><span class="w"> </span><span class="nx">rpc</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;install admin ...\n&quot;</span><span class="p">);</span>
<span class="k">await</span><span class="w"> </span><span class="nx">admin</span><span class="p">.</span><span class="nx">installPlayer</span><span class="p">();</span>
</code></pre></div></p>
</div>
<p>If the transaction is in the <code>in-progress</code> state, the function will skip the deposit process as this indicates that something went wrong during the deposit process and requires manual intervention.</p>
<p>If the transaction is in the <code>completed</code> state, the function will skip the deposit process as this indicates that the deposit has already been processed.</p>
<h2 id="deposit-action">Deposit Action</h2>
<p>Let's take a look on how admin deposit the token into the zkWasm Rollup Application, in <code>process</code> function in state.rs of the zkWasm Rollup Application (<a href="https://github.com/riddles-are-us/zkwasm-automata/blob/main/src/state.rs">automata</a>):</p>
<p><div class="highlight"><pre><span></span><code><span class="n">DEPOSIT</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">require</span><span class="p">(</span><span class="o">*</span><span class="n">pkey</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">*</span><span class="n">ADMIN_PUBKEY</span><span class="p">)</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="bp">self</span><span class="p">.</span><span class="n">deposit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">AutomataPlayer</span><span class="p">::</span><span class="n">pkey_to_pid</span><span class="p">(</span><span class="n">pkey</span><span class="p">))</span>
<span class="w">        </span><span class="p">.</span><span class="n">map_or_else</span><span class="p">(</span><span class="o">|</span><span class="n">e</span><span class="o">|</span><span class="w"> </span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
When it receives a deposit request (<code>admin.deposit(pid_1, pid_2, amountInEther)</code> called in the deposit monitor), it will check if the request is coming from the admin by checking if the public key is the admin's public key (You will get the admin's public key generated from your private key when you build the zkWasm Rollup Application using <code>make build</code>). If it is, it will call the <code>deposit</code> function.</p>
<p>Let's take a look at the <code>deposit</code> function in the zkWasm Rollup Application:</p>
<div class="highlight"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">deposit</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="p">[</span><span class="kt">u64</span><span class="p">;</span><span class="w"> </span><span class="mi">2</span><span class="p">])</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="kt">u32</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">//zkwasm_rust_sdk::dbg!(&quot;deposit\n&quot;);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">admin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AutomataPlayer</span><span class="p">::</span><span class="n">get_from_pid</span><span class="p">(</span><span class="n">pid</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">    </span><span class="n">admin</span><span class="p">.</span><span class="n">check_and_inc_nonce</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">nonce</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AutomataPlayer</span><span class="p">::</span><span class="n">get_from_pid</span><span class="p">(</span><span class="o">&amp;</span><span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]]);</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">player</span><span class="p">.</span><span class="n">as_mut</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AutomataPlayer</span><span class="p">::</span><span class="n">new_from_pid</span><span class="p">([</span><span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]]);</span>
<span class="w">            </span><span class="n">player</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">cost_balance</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i64</span><span class="p">))</span><span class="o">?</span><span class="p">;</span>
<span class="w">            </span><span class="n">player</span><span class="p">.</span><span class="n">store</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="nb">Some</span><span class="p">(</span><span class="n">player</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">player</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">cost_balance</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i64</span><span class="p">))</span><span class="o">?</span><span class="p">;</span>
<span class="w">            </span><span class="n">player</span><span class="p">.</span><span class="n">store</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="n">admin</span><span class="p">.</span><span class="n">store</span><span class="p">();</span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span><span class="w"> </span><span class="c1">// no error occurred</span>
<span class="p">}</span>
</code></pre></div>
<p>Remind how we call the <code>deposit</code> function in the deposit monitor we use the <code>pid_1</code> and <code>pid_2</code> to identify the player, and the <code>amount</code> to specify the amount of the token to be deposited:</p>
<div class="highlight"><pre><span></span><code><span class="k">await</span><span class="w"> </span><span class="nx">admin</span><span class="p">.</span><span class="nx">deposit</span><span class="p">(</span><span class="nx">pid_1</span><span class="p">,</span><span class="w"> </span><span class="nx">pid_2</span><span class="p">,</span><span class="w"> </span><span class="nx">amountInEther</span><span class="p">);</span>
</code></pre></div>
<p>So the <code>deposit</code> function will first get the player from the pid, then check if the player exists, if not, it will create a new player with the pid, then it will add the amount to the player's balance by <code>player.data.cost_balance(-(self.data[2] as i64))?;</code>.</p>
<div class="admonition tip">
<p class="admonition-title">Balance Update</p>
<p>The <code>cost_balance</code> function in the zkWasm Rollup Application handles both deposit and withdrawal operations through a clever use of positive and negative values. Here's how it works:</p>
<p>When processing a deposit with <code>cost_balance(-x)</code>, the function:
1. Checks if <code>treasure &gt;= -x</code>
2. Executes <code>treasure -= (-x)</code>, which is equivalent to <code>treasure += x</code></p>
<p>This is why in the deposit function we see <code>cost_balance(-(self.data[2] as i64))</code>:
- First converts <code>self.data[2]</code> to a 64-bit integer
- Takes its negative value to make it a deposit operation
- Uses <code>cost_balance</code> to update the balance</p>
<p>This is a common design pattern where a single function handles both increasing and decreasing balances, using the sign of the value to determine the operation type. When the input is negative, it becomes a deposit (increasing balance), and when positive, it becomes a withdrawal (decreasing balance).</p>
<p>Here's the implementation:
<div class="highlight"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">cost_balance</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">:</span><span class="w"> </span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="kt">u32</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">treasure</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">local</span><span class="p">.</span><span class="mf">0.</span><span class="n">last_mut</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">*</span><span class="n">treasure</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="o">*</span><span class="n">treasure</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">b</span><span class="p">;</span>
<span class="w">            </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nb">Err</span><span class="p">(</span><span class="n">ERROR_NOT_ENOUGH_BALANCE</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="fm">unreachable!</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
<p>The balance (or "treasure") is stored in the last element of the player's <code>local</code> array, which is part of the player's data structure containing balance and other information.</p>
</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.indexes", "navigation.instant", "navigation.tracking", "navigation.sections", "navigation.expand", "navigation.top", "search.suggest", "content.code.copy", "search.highlight"], "search": "../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.83f73b43.min.js"></script>
      
        <script src="https://unpkg.com/mermaid@10.6.1/dist/mermaid.min.js"></script>
      
    
  </body>
</html>