
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../zkwasm-mini-rollup/Rollup%20Convention.html">
      
      
        <link rel="next" href="Deposit.html">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.45">
    
    
      
        <title>zkWasm Protocol Overview - zkWasm Development Recipe</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.0253249f.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="pink">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#zkwasm-protocol-overview" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../index.html" title="zkWasm Development Recipe" class="md-header__button md-logo" aria-label="zkWasm Development Recipe" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            zkWasm Development Recipe
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              zkWasm Protocol Overview
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="pink"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="blue" data-md-color-accent="lime"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../index.html" title="zkWasm Development Recipe" class="md-nav__button md-logo" aria-label="zkWasm Development Recipe" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    zkWasm Development Recipe
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../index.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Getting Started
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Getting Started
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Setup%20Environment.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Setup Environment
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Quick%20Tutorial.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Quick Tutorial
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Core Documentation
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Core Documentation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Core%20Concepts.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Core Concepts
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../zkWasm%20Overview.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    zkWasm Overview
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Design Guide
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Design Guide
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Design%20Application%20as%20State%20Machine.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Design Application as State Machine
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Development Guide
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Development Guide
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../zkWasm%20Rust%20SDK.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    zkWasm Rust SDK
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Web3%20Development%20Frameworks.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Web3 Development Frameworks
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="">
            
  
  <span class="md-ellipsis">
    zkWasm Mini Rollup
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            zkWasm Mini Rollup
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../zkwasm-mini-rollup/Rollup%20Overview.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../zkwasm-mini-rollup/Rollup%20Host.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Host Environment
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../zkwasm-mini-rollup/Rollup%20Database.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Database Service
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../zkwasm-mini-rollup/Rollup%20Server.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Server Implementation (zkWasm-ts-Server)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../zkwasm-mini-rollup/Rollup%20Convention.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Convension
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" checked>
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="">
            
  
  <span class="md-ellipsis">
    zkWasm Protocol
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            zkWasm Protocol
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    zkWasm Protocol Overview
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="zkWasm%20Protocol.html" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    zkWasm Protocol Overview
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      Overview
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#core-components" class="md-nav__link">
    <span class="md-ellipsis">
      Core Components
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Core Components">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#proxy-contract" class="md-nav__link">
    <span class="md-ellipsis">
      Proxy Contract
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Proxy Contract">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#initialization" class="md-nav__link">
    <span class="md-ellipsis">
      Initialization
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#state-management" class="md-nav__link">
    <span class="md-ellipsis">
      State Management
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#access-control" class="md-nav__link">
    <span class="md-ellipsis">
      Access Control
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#token-management" class="md-nav__link">
    <span class="md-ellipsis">
      Token Management
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#transaction-management" class="md-nav__link">
    <span class="md-ellipsis">
      Transaction Management
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#settlement-flow" class="md-nav__link">
    <span class="md-ellipsis">
      Settlement Flow
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#transaction-execution" class="md-nav__link">
    <span class="md-ellipsis">
      Transaction Execution
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#verifier-interface" class="md-nav__link">
    <span class="md-ellipsis">
      Verifier Interface
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#transaction-interface" class="md-nav__link">
    <span class="md-ellipsis">
      Transaction Interface
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Deposit.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Deposit
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Withdraw.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Withdraw
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      Overview
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#core-components" class="md-nav__link">
    <span class="md-ellipsis">
      Core Components
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Core Components">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#proxy-contract" class="md-nav__link">
    <span class="md-ellipsis">
      Proxy Contract
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Proxy Contract">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#initialization" class="md-nav__link">
    <span class="md-ellipsis">
      Initialization
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#state-management" class="md-nav__link">
    <span class="md-ellipsis">
      State Management
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#access-control" class="md-nav__link">
    <span class="md-ellipsis">
      Access Control
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#token-management" class="md-nav__link">
    <span class="md-ellipsis">
      Token Management
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#transaction-management" class="md-nav__link">
    <span class="md-ellipsis">
      Transaction Management
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#settlement-flow" class="md-nav__link">
    <span class="md-ellipsis">
      Settlement Flow
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#transaction-execution" class="md-nav__link">
    <span class="md-ellipsis">
      Transaction Execution
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#verifier-interface" class="md-nav__link">
    <span class="md-ellipsis">
      Verifier Interface
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#transaction-interface" class="md-nav__link">
    <span class="md-ellipsis">
      Transaction Interface
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="zkwasm-protocol-overview">zkWasm Protocol Overview</h1>
<h2 id="overview">Overview</h2>
<p>zkWasm-Protocol is a specialized blockchain protocol designed to facilitate the settlement of zkWASM mini-rollups. It provides a robust framework for handling zero-knowledge proof verification and transaction processing in a secure and efficient manner. Specifically, it enables deposit and withdrawal of assets between the zkWASM mini-rollup application and the on-chain zkWasm-Protocol.</p>
<h2 id="core-components">Core Components</h2>
<ul>
<li>Proxy Contract: The central hub for transaction processing and state management for a specific application.</li>
<li>Verifier (interface): Handles zero-knowledge proof verification, each blockchain can have its own verifier, and it can be used for all the applications which have deployed its proxy contract.</li>
<li>Transaction (interface): Supports standardized 32-byte transaction format for processing side effects such as withdrawals which are triggered by settlement (proof verification). </li>
<li>Other Contracts: Additional contracts like ERC20 and NFT Bidding for extended functionality</li>
</ul>
<h3 id="proxy-contract">Proxy Contract</h3>
<h4 id="initialization">Initialization</h4>
<p>When you deploy a proxy contract, you set the chain id and the merkle root of the zkwasm application image: </p>
<div class="highlight"><pre><span></span><code><span class="kt">constructor</span><span class="p">(</span><span class="kt">uint32</span><span class="w"> </span><span class="nv">chain_id</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">root</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span>_proxy_info<span class="p">.</span>chain_id<span class="w"> </span><span class="o">=</span><span class="w"> </span>chain_id<span class="p">;</span>
<span class="w">    </span>_proxy_info<span class="p">.</span>owner<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">msg.sender</span><span class="p">;</span>
<span class="w">    </span>merkle_root<span class="w"> </span><span class="o">=</span><span class="w"> </span>root<span class="p">;</span>
<span class="w">    </span>rid<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>And the owner is set to be the deployer of the proxy contract.</p>
<h4 id="state-management">State Management</h4>
<p>In proxy contract, we have plenty of state variables to manage the state of the application:</p>
<div class="highlight"><pre><span></span><code>TokenInfo<span class="p">[]</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span>_tokens<span class="p">;</span>
Transaction<span class="p">[]</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span>transactions<span class="p">;</span>
DelphinusVerifier<span class="w"> </span><span class="kt">public</span><span class="w"> </span>verifier<span class="p">;</span>
ProxyInfo<span class="w"> </span>_proxy_info<span class="p">;</span>

<span class="kt">address</span><span class="w"> </span><span class="k">internal </span><span class="nv">_settler</span><span class="p">;</span>
<span class="kt">uint256</span><span class="p">[</span><span class="m m-Decimal">3</span><span class="p">]</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span>zk_image_commitments<span class="p">;</span>
<span class="kt">uint256</span><span class="w"> </span><span class="k">public </span><span class="nv">merkle_root</span><span class="p">;</span>
<span class="kt">uint256</span><span class="w"> </span><span class="k">public </span><span class="nv">rid</span><span class="p">;</span>
<span class="kt">uint256</span><span class="w"> </span><span class="k">public </span><span class="nv">withdrawLimit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">10000</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="err">1</span>e18<span class="p">;</span><span class="w"> </span><span class="c1">//10000 Ti limit per settle</span>

<span class="kt">mapping</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kt">bool</span><span class="p">)</span><span class="w"> </span><span class="kt">private</span><span class="w"> </span>_tmap<span class="p">;</span>
<span class="kt">mapping</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kt">bool</span><span class="p">)</span><span class="w"> </span><span class="kt">private</span><span class="w"> </span>hasSideEffect<span class="p">;</span>
</code></pre></div>
<p>Where:</p>
<ul>
<li><code>TokenInfo[] public _tokens;</code> is an array of all the tokens supported by the application.</li>
<li><code>Transaction[] public transactions;</code> is an array of all the transaction types added to the proxy contract, such as withdrawals. </li>
<li><code>DelphinusVerifier public verifier;</code> is the verifier for the application.</li>
<li><code>ProxyInfo _proxy_info;</code> is the information of the proxy contract, including the chain id, added token amount, added pool amount, owner address, merkle root, rid, verifier id, etc.</li>
<li><code>address internal _settler;</code> is the address of the settler, which can be set by the owner of the proxy contract.</li>
<li><code>uint256[3] public zk_image_commitments;</code> is the commitments of the zkwasm application image.</li>
<li><code>uint256 public merkle_root;</code> is the merkle root of the zkwasm application image.</li>
<li><code>uint256 public rid;</code> indicates the settlement round id or number.</li>
<li><code>uint256 public withdrawLimit = 10000 * 1e18; //10000 Ti limit per settle</code> is the limit of the withdrawals.</li>
<li><code>mapping(uint256 =&gt; bool) private _tmap;</code> is a mapping of the token uids to the boolean value, indicating whether the token is supported by the application.</li>
<li><code>mapping(uint256 =&gt; bool) private hasSideEffect;</code> is a mapping of the transaction uids to the boolean value, indicating whether the transaction has side effects.</li>
</ul>
<p>After the proxy contract is deployed, you have to specify the verifier contract address for the application, which is the verifier that will be used to verify the proofs of the transactions:</p>
<div class="highlight"><pre><span></span><code><span class="kt">function</span><span class="w"> </span><span class="nv">setVerifier</span><span class="p">(</span><span class="kt">address</span><span class="w"> </span><span class="nv">vaddr</span><span class="p">)</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span>onlyOwner<span class="w"> </span><span class="p">{</span>
<span class="w">    </span>verifier<span class="w"> </span><span class="o">=</span><span class="w"> </span>DelphinusVerifier<span class="p">(</span>vaddr<span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>You can also set the withdraw limit for the application, which is the maximum amount of withdrawal that can be processed in a single transaction:</p>
<div class="highlight"><pre><span></span><code><span class="kt">function</span><span class="w"> </span><span class="nv">setWithdrawLimit</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">amount</span><span class="p">)</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span>onlyOwner<span class="w"> </span><span class="p">{</span>
<span class="w">    </span>withdrawLimit<span class="w"> </span><span class="o">=</span><span class="w"> </span>amount<span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>Moreover, in order to ensure the verification is not misused (for example, someone may verify a proof generated from a different zkWasm application), we have to set the image commitment for the application:</p>
<div class="highlight"><pre><span></span><code><span class="kt">function</span><span class="w"> </span><span class="nv">setVerifierImageCommitments</span><span class="p">(</span><span class="kt">uint256</span><span class="p">[</span><span class="m m-Decimal">3</span><span class="p">]</span><span class="w"> </span>calldata<span class="w"> </span>commitments<span class="p">)</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span>onlyOwner<span class="w"> </span><span class="p">{</span>
<span class="w">    </span>zk_image_commitments<span class="p">[</span><span class="m m-Decimal">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>commitments<span class="p">[</span><span class="m m-Decimal">0</span><span class="p">];</span>
<span class="w">    </span>zk_image_commitments<span class="p">[</span><span class="m m-Decimal">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>commitments<span class="p">[</span><span class="m m-Decimal">1</span><span class="p">];</span>
<span class="w">    </span>zk_image_commitments<span class="p">[</span><span class="m m-Decimal">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>commitments<span class="p">[</span><span class="m m-Decimal">2</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div>
<p>You can get the image commitment when you add the image to the <a href="https://explorer.zkwasmhub.com/">zkWasm Hub</a> or compute it by yourself using <code>ts/commitment.ts</code> in the <a href="https://github.com/DelphinusLab/zkwasm-mini-rollup">zkWasm Mini=Rollup Repository</a>.</p>
<h4 id="access-control">Access Control</h4>
<p>There are two kinds of access control in the proxy contract:</p>
<div class="highlight"><pre><span></span><code><span class="kt">modifier</span><span class="w"> </span>onlyOwner<span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">require</span><span class="p">(</span><span class="k">msg.sender</span><span class="w"> </span><span class="o">==</span><span class="w"> </span>_proxy_info<span class="p">.</span>owner<span class="p">,</span><span class="w"> </span><span class="s2">&quot;Only owner can call this function&quot;</span><span class="p">);</span>
<span class="w">    </span>_<span class="p">;</span>
<span class="p">}</span>

<span class="kt">modifier</span><span class="w"> </span>onlySettler<span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">require</span><span class="p">(</span><span class="k">msg.sender</span><span class="w"> </span><span class="o">==</span><span class="w"> </span>_settler<span class="p">,</span><span class="w"> </span><span class="s2">&quot;Only settler can call this function&quot;</span><span class="p">);</span>
<span class="w">    </span>_<span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li><code>onlyOwner</code> modifier is used to restrict access to the owner of the proxy contract.</li>
<li><code>onlySettler</code> modifier is used to restrict access to the settler of the proxy contract.</li>
</ul>
<p>The owner and settler can be set by the owner of the proxy contract:</p>
<div class="highlight"><pre><span></span><code><span class="kt">function</span><span class="w"> </span><span class="nv">setOwner</span><span class="p">(</span><span class="kt">address</span><span class="w"> </span><span class="nv">new_owner</span><span class="p">)</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span>onlyOwner<span class="w"> </span><span class="p">{</span>
<span class="w">    </span>_proxy_info<span class="p">.</span>owner<span class="w"> </span><span class="o">=</span><span class="w"> </span>new_owner<span class="p">;</span>
<span class="p">}</span>

<span class="kt">function</span><span class="w"> </span><span class="nv">setSettler</span><span class="p">(</span><span class="kt">address</span><span class="w"> </span><span class="nv">settler</span><span class="p">)</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span>onlyOwner<span class="w"> </span><span class="p">{</span>
<span class="w">    </span>_settler<span class="w"> </span><span class="o">=</span><span class="w"> </span>settler<span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="token-management">Token Management</h4>
<p>An important feature of the proxy contract is to manage the tokens supported by the application, which is used for settlement operations such as transfer, withdraw, deposit, etc. </p>
<p>The owner of the proxy contract can add or modify the tokens supported by the application:</p>
<div class="highlight"><pre><span></span><code><span class="kt">function</span><span class="w"> </span><span class="nv">addToken</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">token</span><span class="p">)</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span>onlyOwner<span class="w"> </span><span class="kt">returns</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">uint32</span><span class="w"> </span><span class="nv">cursor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">uint32</span><span class="p">(</span>_tokens<span class="p">.</span>length<span class="p">);</span><span class="w"> </span><span class="c1">// cursor is the index of the token in the _tokens array</span>
<span class="w">    </span>_tokens<span class="p">.</span>push<span class="p">(</span>TokenInfo<span class="p">(</span>token<span class="p">));</span><span class="w"> </span><span class="c1">// add the token to the _tokens array</span>
<span class="w">    </span>_proxy_info<span class="p">.</span>amount_token<span class="w"> </span><span class="o">=</span><span class="w"> </span>cursor<span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m m-Decimal">1</span><span class="p">;</span><span class="w"> </span><span class="c1">// update the amount of the tokens supported by the application</span>
<span class="w">    </span><span class="kt">require</span><span class="p">(</span>_tmap<span class="p">[</span>token<span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;AddToken: Token Already Exist&quot;</span><span class="p">);</span><span class="w"> </span><span class="c1">// check if the token is already supported</span>
<span class="w">    </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>token<span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span>_tmap<span class="p">[</span>token<span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">true</span><span class="p">;</span><span class="w"> </span><span class="c1">// set the token to be supported</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kt">return</span><span class="w"> </span>cursor<span class="p">;</span><span class="w"> </span><span class="c1">// return the index of the token in the _tokens array</span>
<span class="p">}</span>


<span class="kt">function</span><span class="w"> </span><span class="nv">modifyToken</span><span class="p">(</span><span class="kt">uint32</span><span class="w"> </span><span class="nv">index</span><span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">token</span><span class="p">)</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span>onlyOwner<span class="p">{</span>
<span class="w">    </span><span class="kt">require</span><span class="p">(</span>_tmap<span class="p">[</span>token<span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;AddToken: Token Already Exist&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Check if the index is within bounds of the array</span>
<span class="w">    </span><span class="kt">require</span><span class="p">(</span>index<span class="w"> </span><span class="o">&lt;</span><span class="w"> </span>_tokens<span class="p">.</span>length<span class="p">,</span><span class="w"> </span><span class="s2">&quot;Index out of bounds&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Modify the token at the specified index</span>
<span class="w">    </span>_tokens<span class="p">[</span>index<span class="p">].</span>token_uid<span class="w"> </span><span class="o">=</span><span class="w"> </span>token<span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>You may notice that the <code>token</code> parameter in the <code>addToken</code> and <code>modifyToken</code> functions is of type <code>uint256</code> instead of <code>address</code>. This is because the <code>token</code> is the uid of the token, which is derived from the token address and the chain id, for example, in <code>test/test_utils.ts</code>, we have the following code to derive the uid of the token and add it to the proxy contract:</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ethers</span><span class="p">,</span><span class="w"> </span><span class="nx">getChainId</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;hardhat&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">encodeL1address</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;web3subscriber/src/addresses&quot;</span><span class="p">;</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">chainId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getChainId</span><span class="p">();</span>
<span class="kd">let</span><span class="w"> </span><span class="nx">tokenUid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">encodeL1address</span><span class="p">(</span><span class="nx">tokenAddress</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s2">&quot;0x&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">),</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">chainId</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="mf">16</span><span class="p">));</span>
<span class="kd">let</span><span class="w"> </span><span class="nx">tokenUidString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">tokenUid</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mf">16</span><span class="p">);</span>
<span class="k">await</span><span class="w"> </span><span class="nx">proxy</span><span class="p">.</span><span class="nx">addToken</span><span class="p">(</span><span class="nx">ethers</span><span class="p">.</span><span class="nx">toBigInt</span><span class="p">(</span><span class="s2">&quot;0x&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">tokenUidString</span><span class="p">));</span>
</code></pre></div>
<p>Or in the proxy contract itself, we have <code>_l1_address</code> function to derive the uid of a token or an account:</p>
<div class="highlight"><pre><span></span><code><span class="kt">function</span><span class="w"> </span><span class="nv">_l1_address</span><span class="p">(</span><span class="kt">address</span><span class="w"> </span><span class="nv">account</span><span class="p">)</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span>view<span class="w"> </span><span class="kt">returns</span><span class="w"> </span><span class="p">(</span><span class="kt">uint256</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">return</span>
<span class="w">        </span><span class="p">(</span><span class="kt">uint256</span><span class="p">(</span><span class="kt">uint160</span><span class="p">(</span>account<span class="p">)))</span><span class="w"> </span><span class="o">+</span>
<span class="w">        </span><span class="p">(</span><span class="kt">uint256</span><span class="p">(</span>_proxy_info<span class="p">.</span>chain_id<span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="m m-Decimal">160</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>Why add chain id to the uid? This is because the uid is used to identify the token, and the chain id is used to identify the chain, so the uid is unique for a specific token on a specific chain. </p>
<p>You can find if an uid is specific to the blockchain (by checking if the chain id included in the uid is the same as the chain id of the proxy contract) by calling the <code>_is_local</code> function:</p>
<div class="highlight"><pre><span></span><code><span class="kt">function</span><span class="w"> </span><span class="nv">_is_local</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">l1address</span><span class="p">)</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span>view<span class="w"> </span><span class="kt">returns</span><span class="w"> </span><span class="p">(</span><span class="kt">bool</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">return</span><span class="w"> </span><span class="p">((</span>l1address<span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="m m-Decimal">160</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">(</span><span class="kt">uint256</span><span class="p">(</span>_proxy_info<span class="p">.</span>chain_id<span class="p">)));</span>
<span class="p">}</span>
</code></pre></div>
<p>You can view all the uids of the tokens supported by the application by calling the <code>allTokens</code> function:</p>
<div class="highlight"><pre><span></span><code><span class="kt">function</span><span class="w"> </span><span class="nv">allTokens</span><span class="p">()</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span>view<span class="w"> </span><span class="kt">returns</span><span class="w"> </span><span class="p">(</span>TokenInfo<span class="p">[]</span><span class="w"> </span><span class="kt">memory</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">return</span><span class="w"> </span>_tokens<span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="transaction-management">Transaction Management</h4>
<p>The owner of the proxy contract can add the transaction types supported by the application:</p>
<div class="highlight"><pre><span></span><code><span class="kt">function</span><span class="w"> </span><span class="nv">addTransaction</span><span class="p">(</span><span class="kt">address</span><span class="w"> </span><span class="nv">txaddr</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nv">sideEffect</span><span class="p">)</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span>onlyOwner<span class="w"> </span><span class="kt">returns</span><span class="w"> </span><span class="p">(</span><span class="kt">uint256</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">cursor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>transactions<span class="p">.</span>length<span class="p">;</span><span class="w"> </span><span class="c1">// cursor is the index of the transaction type in the transactions array</span>
<span class="w">    </span><span class="kt">require</span><span class="p">(</span>transactions<span class="p">.</span>length<span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m m-Decimal">255</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;TX index out of bound&quot;</span><span class="p">);</span><span class="w"> </span><span class="c1">// check if the index of the transaction type is within bounds of the array</span>
<span class="w">    </span>transactions<span class="p">.</span>push<span class="p">(</span>Transaction<span class="p">(</span>txaddr<span class="p">));</span><span class="w"> </span><span class="c1">// add the transaction type to the transactions array</span>
<span class="w">    </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>sideEffect<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span>hasSideEffect<span class="p">[</span>cursor<span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>sideEffect<span class="p">;</span><span class="w"> </span><span class="c1">// set if the transaction type has side effects</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kt">return</span><span class="w"> </span>cursor<span class="p">;</span><span class="w"> </span><span class="c1">// return the index of the transaction type in the transactions array</span>
<span class="p">}</span>
</code></pre></div>
<p>A common misunstanding is to think that the transaction type is a "real" transaction which can be executed, but it is not. It is just a transaction type which represents a specific kind of transaction such as withdrawals. The parameter <code>txaddr</code> is the address of the deployed transaction type contract which implements the <code>Transaction</code> interface:</p>
<div class="highlight"><pre><span></span><code><span class="k">pragma solidity</span><span class="w"> </span><span class="o">^</span><span class="k">0.8.0</span><span class="p">;</span>

<span class="kt">uint8</span><span class="w"> </span><span class="nv">constant</span><span class="w"> </span>_WITHDRAW<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x0</span><span class="p">;</span>

interface<span class="w"> </span>Transaction<span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">sideEffect</span><span class="p">(</span><span class="kt">bytes</span><span class="w"> </span><span class="nv">calldata</span><span class="w"> </span>args<span class="p">,</span><span class="w"> </span><span class="kt">uint</span><span class="w"> </span><span class="nv">cursor</span><span class="p">)</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span>pure<span class="w"> </span><span class="kt">returns</span><span class="w"> </span><span class="p">(</span><span class="kt">uint256</span><span class="p">[]</span><span class="w"> </span><span class="kt">memory</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>Here's an example of Withdraw.sol which implements the <code>Transaction</code> interface:
<div class="highlight"><pre><span></span><code><span class="k">pragma solidity</span><span class="w"> </span><span class="o">^</span><span class="k">0.8.0</span><span class="p">;</span>
<span class="kt">import</span><span class="w"> </span><span class="s2">&quot;../Transaction.sol&quot;</span><span class="p">;</span>

<span class="k">contract</span><span class="w"> </span><span class="ni">Withdraw</span><span class="w"> </span><span class="kt">is</span><span class="w"> </span>Transaction<span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * u8:op</span>
<span class="cm">     * u8:token_index</span>
<span class="cm">     * u16: reserve (le mode)</span>
<span class="cm">     * u160: addr (be mode)</span>
<span class="cm">     * u64: amount (be mode)</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">sideEffect</span><span class="p">(</span><span class="kt">bytes</span><span class="w"> </span><span class="nv">memory</span><span class="w"> </span>witness<span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">cursor</span><span class="p">)</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span>pure<span class="w"> </span>override<span class="w"> </span><span class="kt">returns</span><span class="w"> </span><span class="p">(</span><span class="kt">uint256</span><span class="p">[]</span><span class="w"> </span><span class="kt">memory</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">uint256</span><span class="p">[]</span><span class="w"> </span><span class="kt">memory</span><span class="w"> </span>ops<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="kt">uint256</span><span class="p">[](</span><span class="m m-Decimal">4</span><span class="p">);</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">data32</span><span class="p">;</span><span class="w"> </span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>cursor<span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m m-Decimal">32</span><span class="p">;</span>
<span class="w">        </span>assembly<span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Load the 32 bytes of data from memory</span>
<span class="w">            </span>data32<span class="w"> </span><span class="o">:=</span><span class="w"> </span>mload<span class="p">(</span>add<span class="p">(</span>witness<span class="p">,</span><span class="w"> </span>offset<span class="p">))</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="c1">//ops[0] = uint256( (data32 &gt;&gt; (31*8)) &amp; 0xFF );</span>
<span class="w">        </span>ops<span class="p">[</span><span class="m m-Decimal">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>_WITHDRAW<span class="p">;</span>
<span class="w">        </span><span class="c1">// token index</span>
<span class="w">        </span>ops<span class="p">[</span><span class="m m-Decimal">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">uint256</span><span class="p">(</span><span class="w"> </span><span class="p">(</span>data32<span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">(</span><span class="m m-Decimal">30</span><span class="o">*</span><span class="m m-Decimal">8</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x00FF</span><span class="w"> </span><span class="p">);</span>
<span class="w">        </span><span class="c1">// amount to withdraw (wei not considered</span>
<span class="w">        </span>ops<span class="p">[</span><span class="m m-Decimal">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">uint256</span><span class="p">(</span><span class="w"> </span>data32<span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xFFFFFFFFFFFFFFFF</span><span class="w"> </span><span class="p">);</span>
<span class="w">        </span><span class="c1">// recipent address</span>
<span class="w">        </span>ops<span class="p">[</span><span class="m m-Decimal">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">uint256</span><span class="p">(</span><span class="w"> </span><span class="p">(</span>data32<span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">(</span><span class="m m-Decimal">8</span><span class="o">*</span><span class="m m-Decimal">8</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x00FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF</span><span class="w"> </span><span class="p">);</span>
<span class="w">        </span><span class="kt">return</span><span class="w"> </span>ops<span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
You will need to deploy the Withdraw.sol contract and add its address to the proxy contract through the <code>addTransaction</code> function to enable the withdrawals.</p>
<h4 id="settlement-flow">Settlement Flow</h4>
<p>If you have deployed the proxy contract, transaction types contracts, and added the transaction types and tokens, you can start the settlement flow by calling the <code>verify</code> function:</p>
<div class="highlight"><pre><span></span><code><span class="kt">function</span><span class="w"> </span><span class="nv">verify</span><span class="p">(</span>
<span class="w">    </span><span class="kt">bytes</span><span class="w"> </span><span class="nv">calldata</span><span class="w"> </span>tx_data<span class="p">,</span>
<span class="w">    </span><span class="kt">uint256</span><span class="p">[]</span><span class="w"> </span>calldata<span class="w"> </span>proof<span class="p">,</span>
<span class="w">    </span><span class="kt">uint256</span><span class="p">[]</span><span class="w"> </span>calldata<span class="w"> </span>verify_instance<span class="p">,</span>
<span class="w">    </span><span class="kt">uint256</span><span class="p">[]</span><span class="w"> </span>calldata<span class="w"> </span>aux<span class="p">,</span>
<span class="w">    </span><span class="kt">uint256</span><span class="p">[][]</span><span class="w"> </span>calldata<span class="w"> </span>instances
<span class="p">)</span><span class="w"> </span>onlySettler<span class="w"> </span>nonReentrant<span class="w"> </span><span class="kt">public</span><span class="p">{...}</span>
</code></pre></div>
<p>The <code>verify</code> function takes the following parameters:</p>
<ul>
<li><code>tx_data</code>: the data of the transactions to be processed.</li>
<li><code>proof</code>: the proof of the transactions and state transition.</li>
<li><code>verify_instance</code>: the commitments of the application image.</li>
<li><code>aux</code>: the auxiliary data of the proof which is used to support the verification.</li>
<li><code>instances</code>: the instances of the proof, including the sha256 hash of the transactions and merkle root before and after the state transition.</li>
</ul>
<p>To verify the proof, the function first checks if the commitments of the application image are correct:</p>
<div class="highlight"><pre><span></span><code><span class="kt">if</span><span class="w"> </span><span class="p">(</span>zk_image_commitments<span class="p">[</span><span class="m m-Decimal">0</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">require</span><span class="p">(</span>verify_instance<span class="p">[</span><span class="m m-Decimal">1</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span>zk_image_commitments<span class="p">[</span><span class="m m-Decimal">0</span><span class="p">],</span><span class="w"> </span><span class="s2">&quot;Invalid image commitment 0&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="kt">require</span><span class="p">(</span>verify_instance<span class="p">[</span><span class="m m-Decimal">2</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span>zk_image_commitments<span class="p">[</span><span class="m m-Decimal">1</span><span class="p">],</span><span class="w"> </span><span class="s2">&quot;Invalid image commitment 1&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="kt">require</span><span class="p">(</span>verify_instance<span class="p">[</span><span class="m m-Decimal">3</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span>zk_image_commitments<span class="p">[</span><span class="m m-Decimal">2</span><span class="p">],</span><span class="w"> </span><span class="s2">&quot;Invalid image commitment 2&quot;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>Then it checks if the transaction data is in valid format and the sha256 hash of the transaction data is consistent with the instances:</p>
<div class="highlight"><pre><span></span><code><span class="kt">if</span><span class="w"> </span><span class="p">(</span>tx_data<span class="p">.</span>length<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m m-Decimal">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">require</span><span class="p">(</span>
<span class="w">        </span>tx_data<span class="p">.</span>length<span class="w"> </span><span class="o">%</span><span class="w"> </span>OP_SIZE<span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;Verify: Insufficient delta operations&quot;</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">sha_pack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">uint256</span><span class="p">(</span>sha256<span class="p">(</span>tx_data<span class="p">));</span>
<span class="w">    </span><span class="kt">require</span><span class="p">(</span>
<span class="w">        </span>sha_pack<span class="w"> </span><span class="o">==</span>
<span class="w">            </span><span class="p">(</span>instances<span class="p">[</span><span class="m m-Decimal">0</span><span class="p">][</span><span class="m m-Decimal">8</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="m m-Decimal">192</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">                </span><span class="p">(</span>instances<span class="p">[</span><span class="m m-Decimal">0</span><span class="p">][</span><span class="m m-Decimal">9</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="m m-Decimal">128</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">                </span><span class="p">(</span>instances<span class="p">[</span><span class="m m-Decimal">0</span><span class="p">][</span><span class="m m-Decimal">10</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="m m-Decimal">64</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">                </span>instances<span class="p">[</span><span class="m m-Decimal">0</span><span class="p">][</span><span class="m m-Decimal">11</span><span class="p">],</span>
<span class="w">        </span><span class="s2">&quot;Inconstant: Sha data inconsistant&quot;</span>
<span class="w">    </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>Then it checks if the merkle root before the state transition is consistent with the instances:</p>
<div class="highlight"><pre><span></span><code><span class="kt">require</span><span class="p">(</span>
<span class="w">    </span>merkle_root<span class="w"> </span><span class="o">==</span>
<span class="w">        </span><span class="p">(</span>instances<span class="p">[</span><span class="m m-Decimal">0</span><span class="p">][</span><span class="m m-Decimal">0</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="m m-Decimal">192</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">            </span><span class="p">(</span>instances<span class="p">[</span><span class="m m-Decimal">0</span><span class="p">][</span><span class="m m-Decimal">1</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="m m-Decimal">128</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">            </span><span class="p">(</span>instances<span class="p">[</span><span class="m m-Decimal">0</span><span class="p">][</span><span class="m m-Decimal">2</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="m m-Decimal">64</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">            </span>instances<span class="p">[</span><span class="m m-Decimal">0</span><span class="p">][</span><span class="m m-Decimal">3</span><span class="p">],</span>
<span class="w">    </span><span class="s2">&quot;Inconstant: Merkle root dismatch&quot;</span>
<span class="p">);</span>
</code></pre></div>
<p>Then it calls the <code>verify</code> function of the verifier contract to verify the proof and process the transactions:</p>
<div class="highlight"><pre><span></span><code><span class="kt">if</span><span class="w"> </span><span class="p">(</span>tx_data<span class="p">.</span>length<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m m-Decimal">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span>sideEffectCalled<span class="w"> </span><span class="o">=</span><span class="w"> </span>perform_txs<span class="p">(</span>tx_data<span class="p">);</span>
<span class="p">}</span>

<span class="kt">uint256</span><span class="w"> </span><span class="nv">new_merkle_root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span>instances<span class="p">[</span><span class="m m-Decimal">0</span><span class="p">][</span><span class="m m-Decimal">4</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="m m-Decimal">192</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">    </span><span class="p">(</span>instances<span class="p">[</span><span class="m m-Decimal">0</span><span class="p">][</span><span class="m m-Decimal">5</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="m m-Decimal">128</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">    </span><span class="p">(</span>instances<span class="p">[</span><span class="m m-Decimal">0</span><span class="p">][</span><span class="m m-Decimal">6</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="m m-Decimal">64</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">    </span>instances<span class="p">[</span><span class="m m-Decimal">0</span><span class="p">][</span><span class="m m-Decimal">7</span><span class="p">];</span>
</code></pre></div>
<p>Finally, it checks if the new merkle root is consistent with the instances and updates the old merkle root with the new merkle root:</p>
<div class="highlight"><pre><span></span><code><span class="kt">uint256</span><span class="w"> </span><span class="nv">new_merkle_root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span>instances<span class="p">[</span><span class="m m-Decimal">0</span><span class="p">][</span><span class="m m-Decimal">4</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="m m-Decimal">192</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">    </span><span class="p">(</span>instances<span class="p">[</span><span class="m m-Decimal">0</span><span class="p">][</span><span class="m m-Decimal">5</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="m m-Decimal">128</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">    </span><span class="p">(</span>instances<span class="p">[</span><span class="m m-Decimal">0</span><span class="p">][</span><span class="m m-Decimal">6</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="m m-Decimal">64</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">    </span>instances<span class="p">[</span><span class="m m-Decimal">0</span><span class="p">][</span><span class="m m-Decimal">7</span><span class="p">];</span>
rid<span class="w"> </span><span class="o">=</span><span class="w"> </span>rid<span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m m-Decimal">1</span><span class="p">;</span><span class="w"> </span><span class="c1">// increment the rid</span>
merkle_root<span class="w"> </span><span class="o">=</span><span class="w"> </span>new_merkle_root<span class="p">;</span><span class="w"> </span><span class="c1">// update the merkle root</span>
</code></pre></div>
<p>You may notice that the instances array use bit shift to pack the data, which is a common technique to save space in the proof, here's how the data is packed:</p>
<div class="highlight"><pre><span></span><code>instances<span class="p">[</span><span class="m m-Decimal">0</span><span class="p">]</span><span class="w"> </span>layout<span class="w"> </span><span class="p">(</span>each<span class="w"> </span>element<span class="w"> </span><span class="kt">is</span><span class="w"> </span><span class="m m-Decimal">64</span><span class="w"> </span>bits<span class="p">)</span><span class="o">:</span>

<span class="p">[</span><span class="m m-Decimal">0</span><span class="o">-</span><span class="m m-Decimal">3</span><span class="p">]</span><span class="o">:</span><span class="w">   </span>Current<span class="w"> </span>Merkle<span class="w"> </span>Root<span class="w"> </span><span class="p">(</span><span class="m m-Decimal">256</span><span class="w"> </span>bits<span class="w"> </span>total<span class="p">)</span>
<span class="w">  </span><span class="p">[</span><span class="m m-Decimal">0</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>Highest<span class="w"> </span><span class="m m-Decimal">64</span><span class="w"> </span>bits
<span class="w">  </span><span class="p">[</span><span class="m m-Decimal">1</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>Second<span class="w"> </span>highest<span class="w"> </span><span class="m m-Decimal">64</span><span class="w"> </span>bits
<span class="w">  </span><span class="p">[</span><span class="m m-Decimal">2</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>Third<span class="w"> </span>highest<span class="w"> </span><span class="m m-Decimal">64</span><span class="w"> </span>bits
<span class="w">  </span><span class="p">[</span><span class="m m-Decimal">3</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>Lowest<span class="w"> </span><span class="m m-Decimal">64</span><span class="w"> </span>bits

<span class="p">[</span><span class="m m-Decimal">4</span><span class="o">-</span><span class="m m-Decimal">7</span><span class="p">]</span><span class="o">:</span><span class="w">   </span>New<span class="w"> </span>Merkle<span class="w"> </span>Root<span class="w"> </span><span class="p">(</span><span class="m m-Decimal">256</span><span class="w"> </span>bits<span class="w"> </span>total<span class="p">)</span>
<span class="w">  </span><span class="p">[</span><span class="m m-Decimal">4</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>Highest<span class="w"> </span><span class="m m-Decimal">64</span><span class="w"> </span>bits
<span class="w">  </span><span class="p">[</span><span class="m m-Decimal">5</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>Second<span class="w"> </span>highest<span class="w"> </span><span class="m m-Decimal">64</span><span class="w"> </span>bits
<span class="w">  </span><span class="p">[</span><span class="m m-Decimal">6</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>Third<span class="w"> </span>highest<span class="w"> </span><span class="m m-Decimal">64</span><span class="w"> </span>bits
<span class="w">  </span><span class="p">[</span><span class="m m-Decimal">7</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>Lowest<span class="w"> </span><span class="m m-Decimal">64</span><span class="w"> </span>bits

<span class="p">[</span><span class="m m-Decimal">8</span><span class="o">-</span><span class="m m-Decimal">11</span><span class="p">]</span><span class="o">:</span><span class="w">  </span>Transaction<span class="w"> </span>Data<span class="w"> </span>Hash<span class="w"> </span><span class="p">(</span><span class="m m-Decimal">256</span><span class="w"> </span>bits<span class="w"> </span>total<span class="p">)</span>
<span class="w">  </span><span class="p">[</span><span class="m m-Decimal">8</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>Highest<span class="w"> </span><span class="m m-Decimal">64</span><span class="w"> </span>bits
<span class="w">  </span><span class="p">[</span><span class="m m-Decimal">9</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>Second<span class="w"> </span>highest<span class="w"> </span><span class="m m-Decimal">64</span><span class="w"> </span>bits
<span class="w">  </span><span class="p">[</span><span class="m m-Decimal">10</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>Third<span class="w"> </span>highest<span class="w"> </span><span class="m m-Decimal">64</span><span class="w"> </span>bits
<span class="w">  </span><span class="p">[</span><span class="m m-Decimal">11</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>Lowest<span class="w"> </span><span class="m m-Decimal">64</span><span class="w"> </span>bits

instances<span class="p">[</span><span class="m m-Decimal">0</span><span class="p">]</span><span class="w"> </span>array<span class="w"> </span><span class="p">(</span><span class="m m-Decimal">12</span><span class="w"> </span>elements<span class="p">)</span><span class="o">:</span>
<span class="o">+---------------+---------------+---------------+---------------+</span>
<span class="o">|</span><span class="w">     </span><span class="p">[</span><span class="m m-Decimal">0</span><span class="p">]</span><span class="w">       </span><span class="o">|</span><span class="w">     </span><span class="p">[</span><span class="m m-Decimal">1</span><span class="p">]</span><span class="w">       </span><span class="o">|</span><span class="w">     </span><span class="p">[</span><span class="m m-Decimal">2</span><span class="p">]</span><span class="w">       </span><span class="o">|</span><span class="w">     </span><span class="p">[</span><span class="m m-Decimal">3</span><span class="p">]</span><span class="w">       </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span>Current<span class="w"> </span>Root<span class="w">  </span><span class="o">|</span><span class="w"> </span>Current<span class="w"> </span>Root<span class="w">  </span><span class="o">|</span><span class="w"> </span>Current<span class="w"> </span>Root<span class="w">  </span><span class="o">|</span><span class="w"> </span>Current<span class="w"> </span>Root<span class="w">  </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="p">(</span>bits<span class="w"> </span><span class="m m-Decimal">255</span><span class="o">-</span><span class="m m-Decimal">192</span><span class="p">)</span><span class="o">|</span><span class="w"> </span><span class="p">(</span>bits<span class="w"> </span><span class="m m-Decimal">191</span><span class="o">-</span><span class="m m-Decimal">128</span><span class="p">)</span><span class="o">|</span><span class="w"> </span><span class="p">(</span>bits<span class="w"> </span><span class="m m-Decimal">127</span><span class="o">-</span><span class="m m-Decimal">64</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span>bits<span class="w"> </span><span class="m m-Decimal">63</span><span class="o">-</span><span class="m m-Decimal">0</span><span class="p">)</span><span class="w">   </span><span class="o">|</span>
<span class="o">+---------------+---------------+---------------+---------------+</span>
<span class="o">|</span><span class="w">     </span><span class="p">[</span><span class="m m-Decimal">4</span><span class="p">]</span><span class="w">       </span><span class="o">|</span><span class="w">     </span><span class="p">[</span><span class="m m-Decimal">5</span><span class="p">]</span><span class="w">       </span><span class="o">|</span><span class="w">     </span><span class="p">[</span><span class="m m-Decimal">6</span><span class="p">]</span><span class="w">       </span><span class="o">|</span><span class="w">     </span><span class="p">[</span><span class="m m-Decimal">7</span><span class="p">]</span><span class="w">       </span><span class="o">|</span>
<span class="o">|</span><span class="w">  </span>New<span class="w"> </span>Root<span class="w">     </span><span class="o">|</span><span class="w">  </span>New<span class="w"> </span>Root<span class="w">     </span><span class="o">|</span><span class="w">  </span>New<span class="w"> </span>Root<span class="w">     </span><span class="o">|</span><span class="w">  </span>New<span class="w"> </span>Root<span class="w">     </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="p">(</span>bits<span class="w"> </span><span class="m m-Decimal">255</span><span class="o">-</span><span class="m m-Decimal">192</span><span class="p">)</span><span class="o">|</span><span class="w"> </span><span class="p">(</span>bits<span class="w"> </span><span class="m m-Decimal">191</span><span class="o">-</span><span class="m m-Decimal">128</span><span class="p">)</span><span class="o">|</span><span class="w"> </span><span class="p">(</span>bits<span class="w"> </span><span class="m m-Decimal">127</span><span class="o">-</span><span class="m m-Decimal">64</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span>bits<span class="w"> </span><span class="m m-Decimal">63</span><span class="o">-</span><span class="m m-Decimal">0</span><span class="p">)</span><span class="w">   </span><span class="o">|</span>
<span class="o">+---------------+---------------+---------------+---------------+</span>
<span class="o">|</span><span class="w">     </span><span class="p">[</span><span class="m m-Decimal">8</span><span class="p">]</span><span class="w">       </span><span class="o">|</span><span class="w">     </span><span class="p">[</span><span class="m m-Decimal">9</span><span class="p">]</span><span class="w">       </span><span class="o">|</span><span class="w">    </span><span class="p">[</span><span class="m m-Decimal">10</span><span class="p">]</span><span class="w">       </span><span class="o">|</span><span class="w">    </span><span class="p">[</span><span class="m m-Decimal">11</span><span class="p">]</span><span class="w">       </span><span class="o">|</span>
<span class="o">|</span><span class="w">   </span>TX<span class="w"> </span>Hash<span class="w">     </span><span class="o">|</span><span class="w">   </span>TX<span class="w"> </span>Hash<span class="w">     </span><span class="o">|</span><span class="w">   </span>TX<span class="w"> </span>Hash<span class="w">     </span><span class="o">|</span><span class="w">   </span>TX<span class="w"> </span>Hash<span class="w">     </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="p">(</span>bits<span class="w"> </span><span class="m m-Decimal">255</span><span class="o">-</span><span class="m m-Decimal">192</span><span class="p">)</span><span class="o">|</span><span class="w"> </span><span class="p">(</span>bits<span class="w"> </span><span class="m m-Decimal">191</span><span class="o">-</span><span class="m m-Decimal">128</span><span class="p">)</span><span class="o">|</span><span class="w"> </span><span class="p">(</span>bits<span class="w"> </span><span class="m m-Decimal">127</span><span class="o">-</span><span class="m m-Decimal">64</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span>bits<span class="w"> </span><span class="m m-Decimal">63</span><span class="o">-</span><span class="m m-Decimal">0</span><span class="p">)</span><span class="w">   </span><span class="o">|</span>
<span class="o">+---------------+---------------+---------------+---------------+</span>
</code></pre></div>
<h4 id="transaction-execution">Transaction Execution</h4>
<p>In settlement, the <code>perform_txs</code> function is called to execute the transactions:</p>
<div class="highlight"><pre><span></span><code><span class="kt">function</span><span class="w"> </span><span class="nv">perform_txs</span><span class="p">(</span>
<span class="w">    </span><span class="kt">bytes</span><span class="w"> </span><span class="nv">calldata</span><span class="w"> </span>tx_data
<span class="p">)</span><span class="w"> </span><span class="kt">private</span><span class="w"> </span><span class="kt">returns</span><span class="w"> </span><span class="p">(</span><span class="kt">uint256</span><span class="p">){</span>
<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">;</span>
<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">batch_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>tx_data<span class="p">.</span>length<span class="w"> </span><span class="o">/</span><span class="w"> </span>OP_SIZE<span class="p">;</span>
<span class="w">    </span><span class="kt">for</span><span class="w"> </span><span class="p">(</span><span class="kt">uint</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">;</span><span class="w"> </span>i<span class="w"> </span><span class="o">&lt;</span><span class="w"> </span>batch_size<span class="p">;</span><span class="w"> </span>i<span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">uint8</span><span class="w"> </span><span class="nv">op_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">uint8</span><span class="p">(</span>bytesToUint<span class="p">(</span>tx_data<span class="p">,</span><span class="w"> </span>i<span class="w"> </span><span class="o">*</span><span class="w"> </span>OP_SIZE<span class="p">,</span><span class="w"> </span><span class="m m-Decimal">1</span><span class="p">));</span>
<span class="w">        </span><span class="kt">require</span><span class="p">(</span>transactions<span class="p">.</span>length<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span>op_code<span class="p">,</span><span class="w"> </span><span class="s2">&quot;TX index out of bound&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>hasSideEffect<span class="p">[</span>op_code<span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span>Transaction<span class="w"> </span>transaction<span class="w"> </span><span class="o">=</span><span class="w"> </span>_get_transaction<span class="p">(</span>op_code<span class="p">);</span>
<span class="w">            </span><span class="kt">uint256</span><span class="p">[]</span><span class="w"> </span><span class="kt">memory</span><span class="w"> </span>update<span class="w"> </span><span class="o">=</span><span class="w"> </span>transaction<span class="p">.</span>sideEffect<span class="p">(</span>tx_data<span class="p">,</span><span class="w"> </span>i<span class="w"> </span><span class="o">*</span><span class="w"> </span>OP_SIZE<span class="p">);</span>
<span class="w">            </span>ret<span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="m m-Decimal">1</span><span class="p">;</span>
<span class="w">            </span>_update_state<span class="p">(</span>update<span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kt">return</span><span class="w"> </span>ret<span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>The <code>tx_data</code> is the data of the transactions to be processed, each transaction is encoded in 32 bytes (<code>OP_SIZE = 32</code> so we divide the <code>tx_data</code> by <code>OP_SIZE</code> to get the number of transactions), and the <code>op_code</code> is the index of the transaction type in the <code>transactions</code> array: </p>
<div class="highlight"><pre><span></span><code>Transaction Data Structure (32 bytes total)
   [1 byte]  op_code (uint8)     // Operation code for transaction type, maximum 255 types
   [1 byte]  token_index         // Index of the token in registry, maximum 255 tokens
   [2 bytes] reserved            // Reserved for future use
   [20 bytes] address            // Ethereum address (160 bits)
   [8 bytes] amount             // Transaction amount value
</code></pre></div>
<p>For each transaction that has side effects, the function get the transaction type from the <code>transactions</code> array and call the <code>sideEffect</code> function of the transaction type contract to get the state updates information. Let's take a look at the <code>Withdraw.sol</code> contract to see how the state updates information is returned:</p>
<div class="highlight"><pre><span></span><code><span class="kt">uint8</span><span class="w"> </span><span class="nv">constant</span><span class="w"> </span>_WITHDRAW<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x0</span><span class="p">;</span>
<span class="kt">function</span><span class="w"> </span><span class="nv">sideEffect</span><span class="p">(</span><span class="kt">bytes</span><span class="w"> </span><span class="nv">memory</span><span class="w"> </span>witness<span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">cursor</span><span class="p">)</span>
<span class="w">    </span><span class="kt">public</span>
<span class="w">    </span>pure
<span class="w">    </span>override
<span class="w">    </span><span class="kt">returns</span><span class="w"> </span><span class="p">(</span><span class="kt">uint256</span><span class="p">[]</span><span class="w"> </span><span class="kt">memory</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">uint256</span><span class="p">[]</span><span class="w"> </span><span class="kt">memory</span><span class="w"> </span>ops<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="kt">uint256</span><span class="p">[](</span><span class="m m-Decimal">4</span><span class="p">);</span>

<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">data32</span><span class="p">;</span>
<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>cursor<span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m m-Decimal">32</span><span class="p">;</span>
<span class="w">    </span>assembly<span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Load the 32 bytes of data from memory</span>
<span class="w">        </span>data32<span class="w"> </span><span class="o">:=</span><span class="w"> </span>mload<span class="p">(</span>add<span class="p">(</span>witness<span class="p">,</span><span class="w"> </span>offset<span class="p">))</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">//ops[0] = uint256( (data32 &gt;&gt; (31*8)) &amp; 0xFF );</span>
<span class="w">    </span>ops<span class="p">[</span><span class="m m-Decimal">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>_WITHDRAW<span class="p">;</span>
<span class="w">    </span><span class="c1">// token index</span>
<span class="w">    </span>ops<span class="p">[</span><span class="m m-Decimal">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">uint256</span><span class="p">(</span><span class="w"> </span><span class="p">(</span>data32<span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">(</span><span class="m m-Decimal">30</span><span class="o">*</span><span class="m m-Decimal">8</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x00FF</span><span class="w"> </span><span class="p">);</span>
<span class="w">    </span><span class="c1">// amount to withdraw (wei not considered</span>
<span class="w">    </span>ops<span class="p">[</span><span class="m m-Decimal">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">uint256</span><span class="p">(</span><span class="w"> </span>data32<span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xFFFFFFFFFFFFFFFF</span><span class="w"> </span><span class="p">);</span>
<span class="w">    </span><span class="c1">// recipent address</span>
<span class="w">    </span>ops<span class="p">[</span><span class="m m-Decimal">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">uint256</span><span class="p">(</span><span class="w"> </span><span class="p">(</span>data32<span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">(</span><span class="m m-Decimal">8</span><span class="o">*</span><span class="m m-Decimal">8</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x00FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF</span><span class="w"> </span><span class="p">);</span>
<span class="w">    </span><span class="kt">return</span><span class="w"> </span>ops<span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>Where <code>witness</code> is the complete transaction data (tx_data) and <code>cursor</code> is the starting position of current transaction (i * OP_SIZE, where i is the index of the transaction in the batch and OP_SIZE is 32). </p>
<p>It returns an array of 4 elements (ops), where the ops has the following layout:
<div class="highlight"><pre><span></span><code>+-------------+-------------+------------------+--------------------+
|    ops[0]   |   ops[1]    |      ops[2]      |       ops[3]       |
|  Operation  | Token Index |     Amount       | Recipient Address  |
| (constant)  |  (8 bits)   |    (64 bits)     |    (160 bits)      |
+-------------+-------------+------------------+--------------------+
</code></pre></div></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You may find hard to understand the assembly code and bit shift operations. You may skip this section if you are not interested in the details. </p>
<p>First, let's understand how bytes memory is laid out:
<div class="highlight"><pre><span></span><code>Memory Layout for &#39;bytes&#39;:
+---------------+------------------------+-----------------+
| Length (32B)  | Actual Data            | ...             |
+---------------+------------------------+-----------------+
 0x00           0x20                   0x40 ...
</code></pre></div></p>
<ul>
<li>First 32 bytes (0x00-0x1F) stores the length of the bytes array located at the start of the memory allocation.</li>
<li>Next 32 bytes (0x20-0x3F) stores the actual data of the bytes array. This is where our first transaction starts.</li>
</ul>
<p>And here's structure of the transaction data:
<div class="highlight"><pre><span></span><code>Memory Position Calculation:
+---------------+------------------+------------------+------------------+
| Length (32B)  |  Transaction 1   | Transaction 2    | Transaction 3    |
+---------------+------------------+------------------+------------------+
 0x00           0x20              0x40              0x60
                 cursor=0          cursor=32         cursor=64
                 offset=32         offset=64         offset=96
</code></pre></div></p>
<p>And that's why cursor needs to be added by 32, it is used to get the memory position of the transaction data to skip the length of the bytes array.</p>
<div class="highlight"><pre><span></span><code><span class="kt">uint256</span><span class="w"> </span><span class="nv">data32</span><span class="p">;</span><span class="w">                    </span><span class="c1">// Will hold our 32 bytes of data</span>
<span class="kt">uint256</span><span class="w"> </span><span class="nv">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>cursor<span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m m-Decimal">32</span><span class="p">;</span><span class="w">      </span><span class="c1">// Calculate the memory position</span>
assembly<span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// add(witness, offset): Calculate final memory address</span>
<span class="w">    </span><span class="c1">// mload: Load 32 bytes from that address into data32</span>
<span class="w">    </span>data32<span class="w"> </span><span class="o">:=</span><span class="w"> </span>mload<span class="p">(</span>add<span class="p">(</span>witness<span class="p">,</span><span class="w"> </span>offset<span class="p">))</span>
<span class="p">}</span>
</code></pre></div>
<p>The <code>add</code> function is used to calculate the final memory address by adding the offset to the witness pointer. The <code>mload</code> function is used to load 32 bytes from that address into <code>data32</code>. Therefore, <code>data32</code> will hold the 32 bytes of the transaction data we want to extract.</p>
<p>And the <code>data32</code> is then used to extract the operation code, token index, amount, and recipient address from the transaction data. For exmaple:</p>
<div class="highlight"><pre><span></span><code>ops<span class="p">[</span><span class="m m-Decimal">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">uint256</span><span class="p">(</span><span class="w"> </span><span class="p">(</span>data32<span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">(</span><span class="m m-Decimal">30</span><span class="o">*</span><span class="m m-Decimal">8</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x00FF</span><span class="w"> </span><span class="p">);</span><span class="w"> </span><span class="c1">//extract the token index</span>
</code></pre></div>
<p>This operation shifts <code>data32</code> right by 30*8 bits (which is 240 bits) and then performs a bitwise AND with <code>0x00FF</code> (which is 255 in decimal). This effectively extracts the last 8 bits of <code>data32</code>, which correspond to the token index: </p>
<div class="highlight"><pre><span></span><code>Original data32 (32 bytes):
+----+----+------+--------------------+------------------+
|op  |tidx|reserv|       address      |      amount      |
+----+----+------+--------------------+------------------+
 31    30   29-28        27-8                 7-0

Step 1: Right Shift (&gt;&gt; 30*8)
Before: 0x[01][02][0000][1234...5678][000F4240]
                 shift right 240 bits (30 bytes)
After:  0x0000...0000[01][02]

Step 2: AND with 0x00FF
0x0000...0000[01][02]
         AND
0x0000...0000[00][FF]
         =
0x0000...0000[00][02]  Final token index value
</code></pre></div>
</div>
<p>After get the ops (which contains the operation code, token index, amount, and recipient address), the function <code>perform_txs</code> will call the <code>_update_state</code> function to execute the transaction and update the state of the application:</p>
<div class="highlight"><pre><span></span><code><span class="cm">/*</span>
<span class="cm">* @dev side effect encoded in the update function</span>
<span class="cm">* deltas = [| opcode; args |]</span>
<span class="cm">*/</span>
<span class="kt">function</span><span class="w"> </span><span class="nv">_update_state</span><span class="p">(</span><span class="kt">uint256</span><span class="p">[]</span><span class="w"> </span><span class="kt">memory</span><span class="w"> </span>deltas<span class="p">)</span><span class="w"> </span><span class="kt">private</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">cursor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">;</span>
<span class="w">    </span><span class="kt">while</span><span class="w"> </span><span class="p">(</span>cursor<span class="w"> </span><span class="o">&lt;</span><span class="w"> </span>deltas<span class="p">.</span>length<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">delta_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>deltas<span class="p">[</span>cursor<span class="p">];</span>
<span class="w">        </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>delta_code<span class="w"> </span><span class="o">==</span><span class="w"> </span>_WITHDRAW<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kt">require</span><span class="p">(</span>
<span class="w">                </span>deltas<span class="p">.</span>length<span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span>cursor<span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m m-Decimal">4</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;Withdraw: Insufficient arg number&quot;</span>
<span class="w">            </span><span class="p">);</span>
<span class="w">            </span>_withdraw<span class="p">(</span>
<span class="w">                </span><span class="kt">uint128</span><span class="p">(</span>deltas<span class="p">[</span>cursor<span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m m-Decimal">1</span><span class="p">]),</span>
<span class="w">                </span><span class="kt">uint128</span><span class="p">(</span>deltas<span class="p">[</span>cursor<span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m m-Decimal">2</span><span class="p">]),</span>
<span class="w">                </span>deltas<span class="p">[</span>cursor<span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m m-Decimal">3</span><span class="p">]</span>
<span class="w">            </span><span class="p">);</span>
<span class="w">            </span>cursor<span class="w"> </span><span class="o">=</span><span class="w"> </span>cursor<span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m m-Decimal">4</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="kt">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span>revert<span class="p">(</span><span class="s2">&quot;SideEffect: UnknownSideEffectCode&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Note that the <code>deltas</code> array is the <code>update</code> array in the <code>perform_txs</code> function and it is the <code>ops</code> array in the <code>sideEffect</code> function. The function matches the <code>delta_code</code> with the operation code and call the corresponding function (<code>_withdraw</code>) to update the state of the application: </p>
<div class="highlight"><pre><span></span><code><span class="cm">/* In convention, the wasm image does not take wei into consideration thus we need to apply  amout * 1e18 * to get the actual amount of withdraw. Please make sure the wei of the withdraw token is 18</span>
<span class="cm">*/</span>
<span class="kt">function</span><span class="w"> </span><span class="nv">_withdraw</span><span class="p">(</span>
<span class="w">    </span><span class="kt">uint128</span><span class="w"> </span><span class="nv">tidx</span><span class="p">,</span>
<span class="w">    </span><span class="kt">uint128</span><span class="w"> </span><span class="nv">amount</span><span class="p">,</span><span class="w">  </span><span class="c1">//in ether</span>
<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">l1recipent</span>
<span class="p">)</span><span class="w"> </span><span class="kt">private</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">tokenid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>get_token_uid<span class="p">(</span>tidx<span class="p">);</span>
<span class="w">    </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>_is_local<span class="p">(</span>tokenid<span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">address</span><span class="w"> </span><span class="nv">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">address</span><span class="p">(</span><span class="kt">uint160</span><span class="p">(</span>tokenid<span class="p">));</span>
<span class="w">        </span><span class="kt">address</span><span class="w"> </span><span class="nv">recipent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">address</span><span class="p">(</span><span class="kt">uint160</span><span class="p">(</span>l1recipent<span class="p">));</span>
<span class="w">        </span><span class="c1">// Sanitity checks</span>
<span class="w">        </span><span class="kt">require</span><span class="p">(</span>recipent<span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kt">address</span><span class="p">(</span><span class="m m-Decimal">0</span><span class="p">),</span><span class="w"> </span><span class="s2">&quot;Withdraw to the zero address&quot;</span><span class="p">);</span>
<span class="w">        </span>IERC20<span class="w"> </span>underlying_token<span class="w"> </span><span class="o">=</span><span class="w"> </span>IERC20<span class="p">(</span>token<span class="p">);</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>underlying_token<span class="p">.</span>balanceOf<span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="kt">this</span><span class="p">));</span>
<span class="w">        </span><span class="kt">require</span><span class="p">(</span>balance<span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span>amount<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="err">1</span>e18<span class="p">,</span><span class="w"> </span><span class="s2">&quot;Insufficient balance for withdraw&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="kt">require</span><span class="p">(</span>amount<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="err">1</span>e18<span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span>withdrawLimit<span class="p">,</span><span class="w"> </span><span class="s2">&quot;Withdraw amount exceed limit&quot;</span><span class="p">);</span>
<span class="w">        </span>TransferHelper<span class="p">.</span>safeTransfer<span class="p">(</span><span class="kt">address</span><span class="p">(</span>underlying_token<span class="p">),</span><span class="w"> </span>recipent<span class="p">,</span><span class="w"> </span>amount<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="err">1</span>e18<span class="p">);</span>
<span class="w">        </span>emit<span class="w"> </span>WithDraw<span class="p">(</span>token<span class="p">,</span><span class="w"> </span>recipent<span class="p">,</span><span class="w"> </span>amount<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="err">1</span>e18<span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>The <code>_withdraw</code> function is straightforward, it will transfer the amount of the withdraw token to the recipient address.</p>
<h3 id="verifier-interface">Verifier Interface</h3>
<p>This is the interface of the verifier contract, which is used to verify the proof and process the transactions in the proxy contract.</p>
<p><div class="highlight"><pre><span></span><code>interface<span class="w"> </span>DelphinusVerifier<span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * @dev snark verification stub</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">verify</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="kt">uint256</span><span class="p">[]</span><span class="w"> </span>calldata<span class="w"> </span>proof<span class="p">,</span>
<span class="w">        </span><span class="kt">uint256</span><span class="p">[]</span><span class="w"> </span>calldata<span class="w"> </span>verify_instance<span class="p">,</span>
<span class="w">        </span><span class="kt">uint256</span><span class="p">[]</span><span class="w"> </span>calldata<span class="w"> </span>aux<span class="p">,</span>
<span class="w">        </span><span class="kt">uint256</span><span class="p">[][]</span><span class="w"> </span>calldata<span class="w"> </span>target_instance
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span>view<span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
Parameters</p>
<ul>
<li>proof<ul>
<li>Contains the zero-knowledge proof data</li>
<li>Generated by the zkWasm prover</li>
<li>Used to verify state transitions</li>
</ul>
</li>
<li>verify_instance<ul>
<li>Contains verification instance data</li>
<li>Includes image commitments</li>
</ul>
</li>
<li>aux<ul>
<li>Auxiliary data for proof verification</li>
<li>Contains helper values for computation</li>
<li>Used to optimize verification process</li>
</ul>
</li>
<li>target_instance<ul>
<li>2D array containing state transition data</li>
<li>First dimension: Multiple instances</li>
<li>Second dimension: State values such as merkle root and transaction hash.</li>
<li>Structure matches the instances array format described earlier</li>
</ul>
</li>
</ul>
<h3 id="transaction-interface">Transaction Interface</h3>
<p>The transaction interface is used to define the transaction types supported by the application. The transaction type contract must implement the <code>sideEffect</code> function to return the state updates information.</p>
<div class="highlight"><pre><span></span><code><span class="kt">uint8</span><span class="w"> </span><span class="nv">constant</span><span class="w"> </span>_WITHDRAW<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x0</span><span class="p">;</span>
<span class="c1">// Additional operation codes can be defined here</span>

interface<span class="w"> </span>Transaction<span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">sideEffect</span><span class="p">(</span><span class="kt">bytes</span><span class="w"> </span><span class="nv">calldata</span><span class="w"> </span>args<span class="p">,</span><span class="w"> </span><span class="kt">uint</span><span class="w"> </span><span class="nv">cursor</span><span class="p">)</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span>pure<span class="w"> </span><span class="kt">returns</span><span class="w"> </span><span class="p">(</span><span class="kt">uint256</span><span class="p">[]</span><span class="w"> </span><span class="kt">memory</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>You can define your own operation code for the transaction type contract which implements this interface. The <code>sideEffect</code> function shall return the state updates information in the format like follows:</p>
<div class="highlight"><pre><span></span><code>[operation, param1, param2, param3, ...]

For WITHDRAW operations:
[_WITHDRAW, token_index, amount, recipient_address]
</code></pre></div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.indexes", "navigation.instant", "navigation.tracking", "navigation.sections", "navigation.expand", "navigation.top", "search.suggest", "content.code.copy", "search.highlight"], "search": "../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.83f73b43.min.js"></script>
      
        <script src="https://unpkg.com/mermaid@10.6.1/dist/mermaid.min.js"></script>
      
    
  </body>
</html>